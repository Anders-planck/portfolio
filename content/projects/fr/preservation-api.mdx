---
title: 'Preservation API'
summary: "Service d'archivage num√©rique pour conservation documents √† long terme conforme aux standards r√©glementaires italiens, avec tests complets et int√©gration AWS"
image: '/images/projects/preservation-api.svg'
author: 'Anders & A-Cube S.r.l.'
publishedAt: '2024-12-01'
tags: ['Symfony', 'PHP', 'API Platform', 'PostgreSQL', 'AWS', 'Docker', 'Behat', 'PHPStan']
---

## Vue d'ensemble

**Preservation API** (Gov-It-API v2) est un service d'archivage num√©rique production-grade qui garantit la conservation √† long terme de documents √©lectroniques en conformit√© avec les standards r√©glementaires italiens. Construit avec Symfony 6.2+ et API Platform 3, il fournit un stockage s√©curis√© et scalable avec validation et testing complets.

### R√©alisations Cl√©s

- üèõÔ∏è **Conformit√© R√©glementaire**: Pleine conformit√© avec lois italiennes conservation num√©rique
- üìä **200+ Sc√©narios Behat**: Couverture testing behavior-driven compl√®te
- üîç **PHPStan Niveau 8**: Analyse statique maximale pour qualit√© code
- ‚òÅÔ∏è **Int√©gration AWS**: S3 pour stockage, Lambda pour traitement
- üê≥ **D√©veloppement Docker**: Environnement d√©veloppement consistant
- üîí **Authentification JWT**: Contr√¥le acc√®s API s√©curis√©
- üì° **API RESTful**: API Platform avec documentation OpenAPI
- ‚ö° **Hautes Performances**: Optimis√© pour grands volumes documents

---

## Architecture Technique

### Conception du Syst√®me

Couche application Symfony 6.2+ avec API Platform 3, Doctrine ORM et Validators. Couche logique m√©tier pour traitement documents, validation et archivage. Int√©gration avec PostgreSQL pour documents, m√©tadonn√©es et logs audit, et services AWS pour stockage S3, processeur Lambda et logs CloudWatch.

### Composants Core

**Ressources API Platform**:
- Entit√© document avec gestion lifecycle
- Suivi m√©tadonn√©es conservation
- Entr√©es log audit
- Gestion utilisateurs et permissions

**Services Symfony**:
- Service traitement documents
- Service validation
- Service stockage (AWS S3)
- Service notifications (AWS Lambda)

---

## Fonctionnalit√©s Core

### 1. Conservation Documents

**Entit√© Document**:
```php
#[ORM\Entity]
#[ApiResource(
    operations: [
        new Get(),
        new GetCollection(),
        new Post(security: "is_granted('ROLE_USER')")
    ]
)]
class Document
{
    #[ORM\Column(length: 255)]
    #[Assert\NotBlank]
    private string $fileName;

    #[ORM\Column(length: 64)]
    #[Assert\NotBlank]
    private string $sha256Hash;

    #[ORM\Column]
    private \DateTimeImmutable $uploadedAt;

    #[ORM\Column(length: 50)]
    #[Assert\Choice(choices: [
        'pending', 'validated', 'preserved', 'error'
    ])]
    private string $status = 'pending';
}
```

**Service Traitement Documents**:
Workflow complet: validation document, upload sur S3 avec chiffrement AES256, g√©n√©ration m√©tadonn√©es conservation, mise √† jour statut document.

**M√©tadonn√©es Conservation**:
```php
private function generatePreservationMetadata(Document $document): array
{
    return [
        'preservation_timestamp' => (new \DateTimeImmutable())->format(\DateTimeInterface::ISO8601),
        'preservation_agent' => 'A-Cube Preservation API v2',
        'checksum_algorithm' => 'SHA-256',
        'checksum_value' => $document->getSha256Hash(),
        'file_format' => mime_content_type($document->getFileName()),
        'file_size' => strlen($document->getS3Key())
    ];
}
```

### 2. Testing Complet avec Behat

**Configuration Behat**:
Suite de tests avec contextes pour documents, API et authentification. Filtres tags pour exclure tests work-in-progress. Int√©gration Symfony2Extension pour kernel et bootstrap.

**Sc√©nario Behat Exemple**:
```gherkin
Feature: Conservation Documents
  Pour me conformer aux exigences r√©glementaires
  Comme client API
  Je dois pouvoir conserver documents de mani√®re s√©curis√©e

  Background:
    Given Je suis authentifi√© comme "user@example.com"

  @critical
  Scenario: Conservation succ√®s document PDF valide
    Given J'ai un document PDF "facture-2024.pdf"
    When J'envoie une requ√™te "POST" √† "/api/documents"
    Then Le code statut r√©ponse doit √™tre 201
    And La r√©ponse doit √™tre en JSON
    And Le n≈ìud JSON "status" doit √™tre √©gal √† "pending"
    And Le n≈ìud JSON "sha256Hash" doit correspondre "/^[a-f0-9]{64}$/"

    When Le document est trait√©
    Then Le statut document doit √™tre "preserved"
    And Le document doit √™tre stock√© dans S3
    And Le document doit avoir m√©tadonn√©es conservation
```

**Impl√©mentation Context Behat**:
Context fournit step definitions pour traitement documents, v√©rification stockage S3 et validation m√©tadonn√©es conservation avec assertions compl√®tes.

### 3. Analyse Statique PHPStan Niveau 8

**Configuration PHPStan**:
```neon
parameters:
    level: 8
    paths:
        - src
        - tests
    checkMissingIterableValueType: true
    checkGenericClassInNonGenericObjectType: true
    reportUnmatchedIgnoredErrors: true
```

**Code Propre PHPStan**:
Utilisation templates generics pour type safety complet, annotations PHPDoc d√©taill√©es pour param√®tres et return types, gestion null safety rigoureuse.

---

## Int√©gration AWS

### Configuration Stockage S3

**Configuration Client S3**:
```php
class S3Service
{
    public function __construct(
        #[Autowire('%env(AWS_REGION)%')]
        private string $region,
        #[Autowire('%env(AWS_S3_BUCKET)%')]
        private string $bucket
    ) {
        $this->client = new S3Client([
            'region' => $this->region,
            'version' => 'latest'
        ]);
    }

    public function upload(string $key, string $content, array $metadata = []): void
    {
        $this->client->putObject([
            'Bucket' => $this->bucket,
            'Key' => $key,
            'Body' => $content,
            'Metadata' => $metadata,
            'ServerSideEncryption' => 'AES256',
            'StorageClass' => 'STANDARD_IA' // Acc√®s peu fr√©quent pour archivage
        ]);
    }
}
```

### Int√©gration Lambda

**Invocation Lambda pour Traitement Documents**:
Invocation asynchrone Lambda pour traitement documents avec payload JSON contenant documentId et action. Traitement arri√®re-plan sans blocage requ√™te HTTP.

---

## Workflow de D√©veloppement

### Environnement D√©veloppement Docker

**docker-compose.yml**:
Services PHP (avec volume mount), PostgreSQL (avec donn√©es persistantes), Nginx (port 8080). Configuration variables d'environnement pour APP_ENV, DATABASE_URL et AWS_S3_BUCKET.

### Ex√©cution Tests

```bash
# Entrer dans container PHP
docker-compose exec php bash

# Installer d√©pendances
composer install

# Ex√©cuter PHPStan
composer run phpstan

# Ex√©cuter tests Behat
composer run behat

# Ex√©cuter tous contr√¥les CI
composer ci
```

---

## D√©ploiement

**Script D√©ploiement**:
```bash
#!/bin/bash

set -e

ENV=${ENV:-dev}
AWS_PROFILE=${AWS_PROFILE:-acube-dev}

echo "D√©ploiement Preservation API sur environnement ${ENV}"

# 1. Ex√©cuter tests
docker-compose exec -T php composer ci

# 2. Build image production
docker build -t preservation-api:${ENV} -f Dockerfile.prod .

# 3. Push sur ECR
aws --profile=${AWS_PROFILE} ecr get-login-password --region eu-west-1 | \
  docker login --username AWS --password-stdin ${ECR_REGISTRY}

docker tag preservation-api:${ENV} ${ECR_REGISTRY}/preservation-api:${ENV}
docker push ${ECR_REGISTRY}/preservation-api:${ENV}

# 4. Mettre √† jour service ECS
aws --profile=${AWS_PROFILE} ecs update-service \
  --cluster preservation-${ENV} \
  --service preservation-api \
  --force-new-deployment
```

---

## Stack Technique R√©capitulatif

### Framework Backend
- Symfony 6.2+ - Framework PHP
- API Platform 3 - REST API
- Doctrine ORM - Abstraction base de donn√©es
- PHP 8.1+ - PHP moderne

### Base de Donn√©es & Stockage
- PostgreSQL - Base de donn√©es relationnelle
- AWS S3 - Stockage documents
- AWS Lambda - Traitement documents

### Testing & Qualit√©
- Behat - BDD testing (200+ sc√©narios)
- PHPStan Niveau 8 - Analyse statique
- PHPUnit - Tests unitaires
- Psalm - Analyse statique additionnelle

### Outils D√©veloppement
- Docker - Conteneurisation
- Composer - Gestion d√©pendances
- Symfony CLI - Serveur d√©veloppement

---

## Conformit√© R√©glementaire

### Standards Conservation Num√©rique Italienne

- **Lignes Directrices AgID**: Pleine conformit√©
- **CAD (Code Administration Num√©rique)**: Certifi√©
- **Horodatage Conservation**: Conforme RFC 3161
- **Format Long Terme**: Support PDF/A
- **Piste Audit**: Logging complet op√©rations

---

## Conclusion

**Preservation API** d√©montre d√©veloppement backend enterprise-grade avec qualit√© code exceptionnelle (PHPStan niveau 8) et testing complet (200+ sc√©narios Behat), garantissant conformit√© r√©glementaire et archivage documents fiable √† long terme.

**Licence**: Propri√©taire (A-Cube S.r.l.)
