---
title: 'Service AWS Lambda Notifier'
summary: 'Syst√®me de notifications serverless construit avec AWS Lambda, SES, SQS et SNS pour envoi email scalable et fiable avec tests complets et support d√©veloppement local'
image: '/images/projects/notifier.svg'
author: 'Anders & A-Cube S.r.l.'
publishedAt: '2024-03-01'
tags: ['AWS Lambda', 'Python', 'Serverless', 'SES', 'SQS', 'SNS', 'SAM']
---

## Vue d'ensemble

**A3-Shared-Notifier** est un service de notifications serverless production-grade construit avec AWS Lambda et Python 3.12. Il fournit un envoi email fiable et scalable via AWS SES avec activation flexible via SQS, SNS et invocation directe Lambda, supportant contenus HTML et texte simple.

### R√©alisations Cl√©s

- ‚ö° **Architecture Serverless**: AWS Lambda pour scalabilit√© infinie
- üìß **Int√©gration AWS SES**: Envoi email fiable avec gestion bounces/plaintes
- üîÑ **Support Multi-Trigger**: SQS, SNS et invocation directe Lambda
- üê≥ **D√©veloppement Local**: SAM Local pour testing bas√© sur Docker
- üß™ **Tests Complets**: Suite tests unitaires et d'int√©gration
- üìä **Logging CloudWatch**: Logging structur√© pour monitoring
- üîí **S√©curit√© IAM**: Principe du privil√®ge minimum
- üöÄ **Pr√™t CI/CD**: Pipeline d√©ploiement automatis√©e avec SAM

---

## Architecture Technique

### Conception du Syst√®me

L'architecture pr√©voit trois sources de trigger (AWS SQS, AWS SNS, invocation directe) qui activent la fonction AWS Lambda (Python 3.12) pour le traitement email et validation. Le Lambda interagit avec AWS SES pour envoi email, suivi bounces et gestion plaintes, et avec CloudWatch pour logs, m√©triques et alarmes.

### Flux Fonction Lambda

1. √âv√©nement SQS/SNS ‚Üí Handler Lambda
2. Validation Payload
3. Parsing Contenu Email
4. G√©n√©ration Email HTML/Texte
5. Envoi via AWS SES
6. Log sur CloudWatch ‚Üí Succ√®s

---

## Fonctionnalit√©s Core

### 1. Handler Lambda

Le handler principal g√®re les √©v√©nements de SQS, SNS et invocation directe. Ex√©cute le parsing de l'√©v√©nement selon la source, traite chaque message avec validation et envoi, g√®re les erreurs avec logging d√©taill√©.

**Validation Message**:
- Champs obligatoires: sender, recipients, subject
- Recipients doit √™tre une liste non vide
- Au moins un parmi text_content ou html_content requis
- Validation format email et domaines

**Construction Email**:
```python
def build_email(sender, recipients, subject, text_content='',
                html_content='', bucket_name=''):
    msg = MIMEMultipart('alternative')
    msg['From'] = sender
    msg['To'] = ', '.join(recipients)
    msg['Subject'] = subject

    if text_content:
        msg.attach(MIMEText(text_content, 'plain'))
    if html_content:
        msg.attach(MIMEText(html_content, 'html'))

    return msg
```

### 2. Int√©gration SQS/SNS

**Format Message SQS**:
```json
{
  "sender": "noreply@acubeapi.com",
  "recipients": ["user@example.com"],
  "subject": "Votre facture est pr√™te",
  "text_content": "La facture #12345 est disponible pour t√©l√©chargement.",
  "html_content": "<h1>Facture Pr√™te</h1><p>Facture #12345 disponible.</p>",
  "bucket_name": "acube-invoices"
}
```

**Int√©gration Topic SNS**:
Publication notifications email sur topic SNS avec gestion abonnements multiples et filtres messages bas√©s sur attributs.

**Traitement File SQS**:
Envoi messages √† file SQS avec batch processing jusqu'√† 10 messages par invocation, visibility timeout configurable et gestion retry automatique.

### 3. D√©veloppement Local avec SAM

**Template SAM**:
D√©finition compl√®te de la fonction Lambda avec configuration runtime Python 3.12, timeout 30s, m√©moire 256MB. Policies SES pour envoi email. √âv√©nements SQS et SNS configur√©s. CloudWatch Log Group avec retention 30 jours.

**Invocation Locale**:
```bash
# Build fonction Lambda
sam build

# Invocation locale avec √©v√©nement test
sam local invoke NotifierFunction \
    --env-vars local/env.json \
    --event tests/events/sqs-email-event.json

# D√©marrage API Gateway local
sam local start-api

# Debug local
sam local invoke NotifierFunction \
    --debug-port 5858 \
    --env-vars local/env.json \
    --event tests/events/sqs-email-event.json
```

### 4. Strat√©gie de Testing

**Tests Unitaires**:
- Validation messages avec donn√©es valides et invalides
- Test handler Lambda avec mock SES client
- Test construction email avec contenus HTML et texte
- V√©rification gestion erreurs et exceptions
- Coverage >90% du code

**Tests d'Int√©gration**:
- Test envoi email avec SES r√©el (emails v√©rifi√©s requis)
- V√©rification int√©gration SQS et SNS
- Test end-to-end du flux complet
- Validation logging CloudWatch

**Exemple Test**:
```python
@patch('src.handler.ses_client')
def test_lambda_handler_success(self, mock_ses):
    mock_ses.send_raw_email.return_value = {
        'MessageId': 'test-message-id-123'
    }

    event = {
        'sender': 'test@example.com',
        'recipients': ['user@example.com'],
        'subject': 'Test Email',
        'text_content': 'Test content'
    }

    response = lambda_handler(event, None)
    assert response['statusCode'] == 200
```

---

## Workflow de D√©veloppement

### Environnement D√©veloppement Docker

**Makefile** pour gestion simplifi√©e:
- `make init`: Initialisation environnement
- `make build`: Build container Docker
- `make test`: Ex√©cution tests complets
- `make tests.unit`: Seulement tests unitaires
- `make tests.integration`: Seulement tests int√©gration
- `make lint`: Validation CloudFormation
- `make invoke.local`: Invocation locale fonction

---

## D√©ploiement

### D√©ploiement SAM

**D√©ploiement sur Dev**:
```bash
sam build -u
sam deploy --profile acube-dev --config-env dev --no-confirm-changeset
```

**D√©ploiement sur Production**:
```bash
sam build -u --use-container
sam deploy --profile acube-prod --config-env production \
  --no-confirm-changeset \
  --parameter-overrides Environment=production LogRetentionDays=90
```

**Configuration SAM** (samconfig.toml):
Configuration s√©par√©e pour environnements dev et production avec stack name, region, capabilities IAM et parameter overrides sp√©cifiques par environnement.

---

## Monitoring & Logging

### CloudWatch Logs

**Logging Structur√©**:
```python
def log_event(event_type: str, data: Dict[str, Any]) -> None:
    log_entry = {
        'timestamp': datetime.utcnow().isoformat(),
        'event_type': event_type,
        'data': data
    }
    logger.info(json.dumps(log_entry))
```

### Alarmes CloudWatch

Configuration alarmes pour:
- Erreurs Lambda (seuil: 5 en 5 minutes)
- Dur√©e ex√©cution anormale
- Throttling invocations
- Dead Letter Queue messages
- Taux bounce email √©lev√©

---

## Stack Technique R√©capitulatif

### Runtime & Framework
- Python 3.12 - Python moderne
- AWS Lambda - Compute serverless
- AWS SAM - Framework d√©ploiement

### Services AWS
- AWS SES - Envoi email
- AWS SQS - File messages
- AWS SNS - Messaging pub/sub
- CloudWatch - Logging & monitoring

### Outils D√©veloppement
- Docker - D√©veloppement local
- Pytest - Framework testing
- Boto3 - AWS SDK pour Python
- cfn-lint - Validation CloudFormation

---

## Best Practices Impl√©ment√©es

1. **Idempotence**: D√©duplication messages via SQS
2. **Gestion Erreurs**: Gestion exceptions compl√®te
3. **Logique Retry**: Visibility timeout SQS et DLQ
4. **Monitoring**: Logging structur√© et alarmes CloudWatch
5. **S√©curit√©**: IAM least privilege, SQS chiffr√©
6. **Testing**: Coverage tests unitaires et int√©gration
7. **Documentation**: Commentaires inline et README
8. **CI/CD**: D√©ploiement automatis√© avec SAM

---

## Conclusion

**A3-Shared-Notifier** d√©montre une architecture serverless production-ready avec AWS Lambda, fournissant notifications email fiables et scalables avec capacit√©s compl√®tes de testing et monitoring.

**Licence**: Propri√©taire (A-Cube S.r.l.)
