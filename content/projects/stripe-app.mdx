---
title: 'Stripe E-Invoicing Extension'
summary: 'Stripe Dashboard UI Extension for comprehensive payment document management, invoice validation, and refund processing with external accounting system integration'
image: '/images/projects/stripe-app.png'
author: 'Anders & A-Cube S.r.l.'
publishedAt: '2024-09-01'
tags: ['Stripe', 'React', 'TypeScript', 'Redux', 'React Hook Form', 'Zod']
---

## Overview

**Stripe E-Invoicing Extension** is a production Stripe Dashboard UI Extension that provides comprehensive payment document management directly within the Stripe Dashboard. Built with the Stripe UI Extension SDK, it enables seamless invoice validation, refund processing, and synchronization with external accounting systems.

### Key Achievements

- ğŸ’³ **Native Stripe Integration**: Embedded directly in Stripe Dashboard
- ğŸ“„ **Invoice Validation**: Real-time validation against accounting standards
- ğŸ’° **Refund Processing**: Streamlined refund workflows with metadata management
- ğŸ”„ **External System Sync**: Bidirectional sync with accounting platforms
- ğŸ“Š **Document Status Tracking**: Comprehensive status management for invoices
- ğŸ¨ **Stripe UI Components**: Consistent design with Stripe's design system
- ğŸ”’ **Secure Metadata Handling**: Encrypted storage of sensitive document data
- âš¡ **Real-time Updates**: Live data synchronization across systems

---

## Technical Architecture

### System Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Stripe Dashboard Environment              â”‚
â”‚      Embedded UI Extension Context                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Stripe UI Extension SDK Integration          â”‚
â”‚   Payment Data â€¢ Metadata API â€¢ Actions           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redux State     â”‚         â”‚   External APIs      â”‚
â”‚ - Documents     â”‚         â”‚   - A-Cube API       â”‚
â”‚ - Focus Views   â”‚         â”‚   - Accounting       â”‚
â”‚ - Validation    â”‚         â”‚   - E-Invoice        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Core Components Architecture

```typescript
// Component hierarchy
PaymentDocumentDetailsView
â”œâ”€â”€ DocumentInfo              // Basic document information
â”œâ”€â”€ GatewayInfo              // Gateway-specific details
â”œâ”€â”€ InvoiceStatus            // Status management UI
â”œâ”€â”€ RefundSection            // Refund processing
â””â”€â”€ MetadataFocusView        // Metadata editor modal
```

---

## Core Features

### 1. Payment Document Management

**Main View Component**:
```typescript
import {
  ContextView,
  usePaymentData,
  useMetadata
} from '@stripe/ui-extension-sdk/context'
import { Box, Inline, Banner } from '@stripe/ui-extension-sdk/ui'

export default function PaymentDocumentDetailsView() {
  const payment = usePaymentData()
  const metadata = useMetadata()
  const { document, loading } = useFetchStripeDocuments(payment.id)

  if (loading) {
    return <LoadingSpinner />
  }

  return (
    <ContextView title="E-Invoice Details">
      <Box css={{ stack: 'y', gap: 'medium' }}>
        {document.validationErrors.length > 0 && (
          <Banner
            type="caution"
            title="Validation Issues"
            description={`${document.validationErrors.length} issues found`}
          />
        )}

        <DocumentInfo document={document} />
        <GatewayInfo payment={payment} />
        <InvoiceStatus
          document={document}
          onStatusChange={handleStatusChange}
        />
        <RefundSection
          payment={payment}
          document={document}
        />
      </Box>
    </ContextView>
  )
}
```

### 2. Invoice Validation

**Real-time Validation Engine**:
```typescript
import { z } from 'zod'

const InvoiceSchema = z.object({
  number: z.string().regex(/^[A-Z]{2}\d{4}-\d{6}$/),
  date: z.string().datetime(),
  amount: z.number().positive(),
  currency: z.enum(['EUR', 'USD', 'GBP']),
  taxInfo: z.object({
    vatNumber: z.string().regex(/^[A-Z]{2}\d{9,12}$/),
    taxableAmount: z.number(),
    taxAmount: z.number(),
    taxRate: z.number().min(0).max(100)
  }),
  lineItems: z.array(z.object({
    description: z.string().min(1),
    quantity: z.number().int().positive(),
    unitPrice: z.number().positive(),
    total: z.number().positive()
  })).min(1)
})

export function useValidateDocuments(document: Invoice) {
  const [errors, setErrors] = useState<ValidationError[]>([])

  useEffect(() => {
    const result = InvoiceSchema.safeParse(document)

    if (!result.success) {
      const validationErrors = result.error.issues.map(issue => ({
        field: issue.path.join('.'),
        message: issue.message,
        code: issue.code
      }))
      setErrors(validationErrors)
    } else {
      setErrors([])
    }
  }, [document])

  return { errors, isValid: errors.length === 0 }
}
```

**Validation Display**:
```typescript
function DocumentInfo({ document }) {
  const { errors, isValid } = useValidateDocuments(document)

  return (
    <Box>
      <Inline css={{ alignY: 'center', gap: 'small' }}>
        <Badge type={isValid ? 'positive' : 'negative'}>
          {isValid ? 'Valid' : `${errors.length} Errors`}
        </Badge>
      </Inline>

      {!isValid && (
        <Box css={{ stack: 'y', gap: 'small', marginTop: 'medium' }}>
          {errors.map((error, index) => (
            <Banner
              key={index}
              type="critical"
              title={error.field}
              description={error.message}
            />
          ))}
        </Box>
      )}
    </Box>
  )
}
```

### 3. Refund Processing

**Refund Workflow**:
```typescript
import { useStripe } from '@stripe/ui-extension-sdk/stripe'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'

const RefundSchema = z.object({
  amount: z.number().positive(),
  reason: z.enum(['duplicate', 'fraudulent', 'requested_by_customer']),
  notes: z.string().optional()
})

export function RefundSection({ payment, document }) {
  const stripe = useStripe()
  const { metadata, preparedMetadata } = usePrepareMetadataForRefund(document)

  const { register, handleSubmit, formState: { errors } } = useForm({
    resolver: zodResolver(RefundSchema)
  })

  const processRefund = async (data) => {
    try {
      // Create refund with metadata
      const refund = await stripe.refunds.create({
        payment_intent: payment.id,
        amount: data.amount * 100, // Convert to cents
        reason: data.reason,
        metadata: {
          ...preparedMetadata,
          invoice_number: document.number,
          refund_notes: data.notes
        }
      })

      // Update document status in external system
      await updateDocumentStatus(document.id, 'refunded')

      return { success: true, refund }
    } catch (error) {
      console.error('Refund failed:', error)
      return { success: false, error }
    }
  }

  return (
    <Box>
      <form onSubmit={handleSubmit(processRefund)}>
        <TextField
          label="Refund Amount"
          type="number"
          {...register('amount')}
          error={errors.amount?.message}
        />

        <Select
          label="Reason"
          {...register('reason')}
        >
          <option value="duplicate">Duplicate</option>
          <option value="fraudulent">Fraudulent</option>
          <option value="requested_by_customer">Customer Request</option>
        </Select>

        <TextArea
          label="Notes (optional)"
          {...register('notes')}
        />

        <Button type="submit">Process Refund</Button>
      </form>
    </Box>
  )
}
```

### 4. Metadata Management

**Metadata Editor Modal**:
```typescript
import { FocusView } from '@stripe/ui-extension-sdk/ui'

export function MetadataFocusView({ document, onClose }) {
  const [metadata, setMetadata] = useState(document.metadata)
  const { updateMetadata } = useMetadataManager()

  const handleSave = async () => {
    await updateMetadata(document.id, metadata)
    onClose()
  }

  return (
    <FocusView
      title="Edit Metadata"
      primaryAction={{
        label: 'Save',
        onPress: handleSave
      }}
      secondaryAction={{
        label: 'Cancel',
        onPress: onClose
      }}
    >
      <Box css={{ stack: 'y', gap: 'medium' }}>
        {Object.entries(metadata).map(([key, value]) => (
          <TextField
            key={key}
            label={formatLabel(key)}
            value={value}
            onChange={(e) => setMetadata({
              ...metadata,
              [key]: e.target.value
            })}
          />
        ))}

        <Button
          onPress={() => setMetadata({
            ...metadata,
            [`custom_field_${Date.now()}`]: ''
          })}
        >
          Add Custom Field
        </Button>
      </Box>
    </FocusView>
  )
}
```

---

## External System Integration

### A-Cube API Integration

**Fetch Invoice Data**:
```typescript
export function useFetchACubeInvoiceAndCreditNotes(documentId: string) {
  const [data, setData] = useState(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    const fetchData = async () => {
      try {
        const response = await fetch(
          `${process.env.ACUBE_API_URL}/documents/${documentId}`,
          {
            headers: {
              'Authorization': `Bearer ${process.env.ACUBE_API_TOKEN}`,
              'Content-Type': 'application/json'
            }
          }
        )

        const document = await response.json()

        // Fetch related credit notes
        const creditNotes = await fetchCreditNotes(documentId)

        setData({
          invoice: document,
          creditNotes
        })
      } catch (error) {
        console.error('Failed to fetch A-Cube data:', error)
      } finally {
        setLoading(false)
      }
    }

    fetchData()
  }, [documentId])

  return { data, loading }
}
```

### Bidirectional Sync

**Status Synchronization**:
```typescript
export async function syncDocumentStatus(
  stripePaymentId: string,
  externalDocumentId: string,
  newStatus: DocumentStatus
) {
  // Update Stripe metadata
  await stripe.paymentIntents.update(stripePaymentId, {
    metadata: {
      document_status: newStatus,
      last_sync: new Date().toISOString()
    }
  })

  // Update external system
  await fetch(`${process.env.ACUBE_API_URL}/documents/${externalDocumentId}`, {
    method: 'PATCH',
    headers: {
      'Authorization': `Bearer ${process.env.ACUBE_API_TOKEN}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      status: newStatus,
      stripe_payment_id: stripePaymentId
    })
  })
}
```

---

## State Management with Redux

**Store Configuration**:
```typescript
import { configureStore, createSlice } from '@reduxjs/toolkit'

const documentsSlice = createSlice({
  name: 'documents',
  initialState: {
    current: null,
    loading: false,
    validationErrors: []
  },
  reducers: {
    setDocument(state, action) {
      state.current = action.payload
    },
    setValidationErrors(state, action) {
      state.validationErrors = action.payload
    }
  }
})

export const store = configureStore({
  reducer: {
    documents: documentsSlice.reducer,
    focusViews: focusViewsSlice.reducer,
    global: globalSlice.reducer
  }
})
```

---

## Development & Deployment

### Local Development

```bash
# 1. Install dependencies
bun install

# 2. Start Stripe Apps development server
stripe apps start

# 3. View in Stripe Dashboard
# Navigate to any payment in test mode
```

### Deployment to Stripe

```bash
# Upload to Stripe account
stripe apps upload -p <account-id>

# Publish to production
stripe apps publish
```

### Environment Configuration

```typescript
// Extension manifest (stripe-app.json)
{
  "id": "com.acube.einvoicing",
  "version": "1.0.0",
  "name": "E-Invoicing Manager",
  "icon": "./icon.svg",
  "permissions": [
    {
      "permission": "payment_intent_read"
    },
    {
      "permission": "payment_intent_write"
    },
    {
      "permission": "refund_write"
    }
  ],
  "ui_extension": {
    "views": [
      {
        "viewport": "stripe.dashboard.payment.detail",
        "component": "PaymentDocumentDetailsView"
      }
    ]
  }
}
```

---

## Technical Stack Summary

### Frontend Framework
- React 17.0.2
- TypeScript 5.3.3
- @stripe/ui-extension-sdk 8.9.3

### State & Forms
- Redux (implicit from description)
- React Hook Form 7.55.0
- Zod 3.24.2
- @hookform/resolvers 3.9.0

### Utilities
- Moment.js 2.30.1
- React Intl 6.6.8
- UUID 10.0.0
- use-debounce 10.0.4

### Development Tools
- ESLint 8.56.0
- Prettier 3.3.2
- Husky 8.0.3
- TypeScript ESLint

---

## Security Considerations

1. **OAuth 2.0**: Stripe API authentication
2. **Scoped Permissions**: Minimal required permissions
3. **Encrypted Metadata**: Sensitive data encryption
4. **Audit Logging**: All actions logged
5. **Rate Limiting**: API request throttling

---

## Conclusion

**Stripe E-Invoicing Extension** demonstrates seamless integration with the Stripe ecosystem, providing essential invoice management capabilities directly within the Stripe Dashboard with robust external system synchronization.

**License**: Proprietary (A-Cube S.r.l.)
